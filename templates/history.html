{% extends "base.html" %}

{% block title %}历史记录 - Echo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/history.css') }}?v=2">
{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <h1 class="history-title">发布历史</h1>
        <div class="history-actions">
            <button class="btn btn-outline select-mode-btn" id="selectModeBtn" onclick="toggleSelectMode()">
                <span>多选</span>
            </button>
            <button class="btn btn-outline clear-btn" id="clearBtn" onclick="clearAllHistory()">
                <span class="icon" style="width: 14px; height: 14px;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/></svg>
                </span>
                <span>清空</span>
            </button>
        </div>
    </div>
    
    <div class="history-filters">
        <div class="filter-group">
            <select class="filter-btn" id="platformFilter" onchange="applyFilters()">
                <option value="">所有平台</option>
                <option value="twitter">X (Twitter)</option>
                <option value="zhihu">知乎</option>
            </select>
            <select class="filter-btn" id="dateFilter" onchange="applyFilters()">
                <option value="">所有时间</option>
                <option value="today">今天</option>
                <option value="week">本周</option>
                <option value="month">本月</option>
            </select>
        </div>
    </div>
    
    <div id="postList" class="history-list">
        <div class="history-empty">加载中...</div>
    </div>
    
    <div id="loadMore" class="load-more" style="display: none;">
        <button class="btn btn-outline" onclick="loadMore()">加载更多</button>
    </div>
</div>

<div class="batch-actions" id="batchActions">
    <span class="batch-info" id="batchCount">已选择 0 项</span>
    <button class="btn btn-outline" onclick="selectAllVisible()">全选</button>
    <button class="btn btn-primary" onclick="deleteSelected()">删除选中</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    let selectMode = false;
    let selectedIds = new Set();
    let allPosts = [];
    
    async function loadPosts(page = 1) {
        if (isLoading) return;
        isLoading = true;
        
        const response = await fetch(`/api/history?page=${page}&per_page=50`);
        const data = await response.json();
        
        if (page === 1) {
            allPosts = data.posts;
        } else {
            allPosts = allPosts.concat(data.posts);
        }
        
        const postList = document.getElementById('postList');
        
        if (page === 1 && data.posts.length === 0) {
            postList.innerHTML = '<div class="history-empty">暂无发布记录</div>';
            return;
        }
        
        const postsHtml = data.posts.map(post => `
            <div class="history-item" data-id="${post.id}">
                <input type="checkbox" class="history-item-checkbox" onchange="toggleSelection(${post.id})">
                <div class="history-item-header">
                    <div class="history-item-meta">
                        <span>${post.created_at}</span>
                    </div>
                    <div class="history-item-actions">
                        <button class="btn btn-outline" onclick="deleteHistory(${post.id})" title="删除">
                            <span class="icon" style="width: 14px; height: 14px;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/></svg>
                            </span>
                        </button>
                    </div>
                </div>
                <div class="history-item-content">${Common.escapeHtml(post.content)}</div>
                ${post.image_paths.length > 0 ? `
                    <div class="history-item-images">
                        ${post.image_paths.map(img => `<img src="${img}" alt="">`).join('')}
                    </div>
                ` : ''}
                <div class="history-item-platforms">
                    ${post.platforms.includes('twitter') ? `
                        <span class="platform-badge ${post.twitter_success ? 'success' : 'failed'}">
                            ${post.twitter_success ? 'X' : 'X 失败'}
                        </span>
                    ` : ''}
                    ${post.platforms.includes('zhihu') ? `
                        <span class="platform-badge ${post.zhihu_success ? 'success' : 'failed'}">
                            ${post.zhihu_success ? '知乎' : '知乎 失败'}
                        </span>
                    ` : ''}
                </div>
            </div>
        `).join('');
        
        if (page === 1) {
            postList.innerHTML = postsHtml;
        } else {
            postList.insertAdjacentHTML('beforeend', postsHtml);
        }
        
        hasMore = data.current_page < data.pages;
        document.getElementById('loadMore').style.display = hasMore ? 'block' : 'none';
        
        if (page > 1) applyFilters();
        
        isLoading = false;
    }
    
    function loadMore() {
        currentPage++;
        loadPosts(currentPage);
    }
    
    async function deleteHistory(postId) {
        if (!confirm('确定要删除这条记录吗？')) return;
        
        const response = await fetch(`/api/history/${postId}`, { method: 'DELETE' });
        const data = await response.json();
        
        if (data.success) {
            const card = document.querySelector(`.history-item[data-id="${postId}"]`);
            if (card) card.remove();
            
            const remaining = document.querySelectorAll('.history-item');
            if (remaining.length === 0) {
                document.getElementById('postList').innerHTML = '<div class="history-empty">暂无发布记录</div>';
                document.getElementById('loadMore').style.display = 'none';
            }
        } else {
            Common.showToast(data.message || '删除失败', 'error');
        }
    }
    
    async function clearAllHistory() {
        if (!confirm('确定要清空所有历史记录吗？此操作不可恢复。')) return;
        
        const response = await fetch('/api/history/clear', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('postList').innerHTML = '<div class="history-empty">暂无发布记录</div>';
            document.getElementById('loadMore').style.display = 'none';
            Common.showToast('清空成功', 'success');
        } else {
            Common.showToast(data.message || '清空失败', 'error');
        }
    }
    
    function toggleSelectMode() {
        selectMode = !selectMode;
        const btn = document.getElementById('selectModeBtn');
        const checkboxes = document.querySelectorAll('.history-item-checkbox');
        const batchActions = document.getElementById('batchActions');
        
        if (selectMode) {
            btn.classList.add('active');
            btn.innerHTML = '<span>完成</span>';
            checkboxes.forEach(cb => cb.classList.add('visible'));
            batchActions.classList.add('show');
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<span>多选</span>';
            checkboxes.forEach(cb => {
                cb.classList.remove('visible');
                cb.checked = false;
            });
            batchActions.classList.remove('show');
            selectedIds.clear();
            updateBatchCount();
        }
    }
    
    function toggleSelection(postId) {
        if (selectedIds.has(postId)) {
            selectedIds.delete(postId);
        } else {
            selectedIds.add(postId);
        }
        updateBatchCount();
    }
    
    function updateBatchCount() {
        document.getElementById('batchCount').textContent = `已选择 ${selectedIds.size} 项`;
    }
    
    function selectAllVisible() {
        const visibleCards = document.querySelectorAll('.history-item:not([style*="display: none"])');
        visibleCards.forEach(card => {
            const id = parseInt(card.dataset.id);
            const checkbox = card.querySelector('.history-item-checkbox');
            checkbox.checked = true;
            selectedIds.add(id);
        });
        updateBatchCount();
    }
    
    async function deleteSelected() {
        if (selectedIds.size === 0) {
            Common.showToast('请先选择要删除的记录', 'error');
            return;
        }
        
        if (!confirm(`确定要删除选中的 ${selectedIds.size} 条记录吗？`)) return;
        
        const ids = Array.from(selectedIds);
        const response = await fetch('/api/history/batch-delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids })
        });
        const data = await response.json();
        
        if (data.success) {
            ids.forEach(id => {
                const card = document.querySelector(`.history-item[data-id="${id}"]`);
                if (card) card.remove();
            });
            selectedIds.clear();
            updateBatchCount();
            
            const remaining = document.querySelectorAll('.history-item');
            if (remaining.length === 0) {
                document.getElementById('postList').innerHTML = '<div class="history-empty">暂无发布记录</div>';
            }
            Common.showToast('删除成功', 'success');
        } else {
            Common.showToast(data.message || '删除失败', 'error');
        }
    }
    
    function applyFilters() {
        const platform = document.getElementById('platformFilter').value;
        const dateRange = document.getElementById('dateFilter').value;
        
        const cards = document.querySelectorAll('.history-item');
        cards.forEach(card => {
            const postId = parseInt(card.dataset.id);
            const post = allPosts.find(p => p.id === postId);
            if (!post) return;
            
            let show = true;
            
            if (platform && !post.platforms.includes(platform)) {
                show = false;
            }
            
            if (dateRange && show) {
                const postDate = new Date(post.created_at);
                const now = new Date();
                
                if (dateRange === 'today') {
                    show = postDate.toDateString() === now.toDateString();
                } else if (dateRange === 'week') {
                    const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    show = postDate >= weekAgo;
                } else if (dateRange === 'month') {
                    show = postDate.getMonth() === now.getMonth() && 
                           postDate.getFullYear() === now.getFullYear();
                }
            }
            
            card.style.display = show ? 'block' : 'none';
        });
    }
    
    loadPosts();
</script>
{% endblock %}
